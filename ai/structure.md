# Структура проекта AI

Данный документ описывает полную структуру подпроекта AI для автоматической генерации тестов.

## Общая структура

Проект организован в виде многоуровневой архитектуры с четким разделением ответственности:
- **apps/** — точки входа (приложения), которые можно запускать независимо
- **libs/** — переиспользуемые библиотеки (нижние слои не импортируют верхние)
- **packages/** — шаблоны и статические ресурсы
- **scripts/** — вспомогательные скрипты для разработки и CI/CD
- **tests/** — тесты (юнит и интеграционные)
- **examples/** — примеры использования
- **docs/** — документация проекта

---

ai/
├─ .gitignore                                  # Локальные игнор-правила для AI подпроекта. Игнорирует __pycache__, виртуальные окружения, IDE файлы, логи, кэши тестов и т.д.
├─ README.md                                   # Основной файл документации подпроекта. Содержит описание, инструкции по установке, настройке и запуску AI сервиса.
├─ pyproject.toml                              # Конфигурация сборки для всего AI подпроекта. Настройки setuptools, метаданные проекта, зависимости на уровне корня.
├─ requirements.txt                            # Список Python зависимостей специфичных для AI подпроекта. Включает FastAPI, LLM библиотеки, инструменты для обработки данных и т.д.
│
├─ scripts/                                    # Директория со вспомогательными скриптами для разработки, CI/CD и автоматизации
│   ├─ check_layer_imports.py                  # CI-скрипт для проверки архитектурных правил. Запрещает импорты из libs в apps (нижние слои не должны зависеть от верхних).
│   ├─ setup_dev_env.sh                        # Скрипт настройки среды разработки. Устанавливает все библиотеки из libs/ в editable mode (pip install -e), настраивает окружение.
│   ├─ format_all.sh                           # Скрипт форматирования кода для всего AI подпроекта. Запускает ruff/black для единообразного стиля кода.
│   └─ run_local_demo.sh                       # Скрипт для локального запуска мини-демонстрации pipeline. Полезен для быстрого тестирования без полного развертывания.
│
├─ apps/                                       # Конечные сервисы (приложения) внутри AI подпроекта — точки входа в систему
│   │                                          # Каждое приложение можно запускать независимо, имеет свои зависимости и конфигурацию
│   │
│   ├─ api/                                    # FastAPI оркестратор — основной REST API сервис для управления pipeline генерации тестов
│   │   ├─ pyproject.toml                      # Конфигурация сборки для API приложения. Метаданные, зависимости специфичные для API сервиса.
│   │   ├─ requirements.txt                    # Python зависимости для API сервиса. FastAPI, uvicorn, HTTP клиенты и специфичные библиотеки.
│   │   └─ src/                                # Исходный код API приложения
│   │       └─ ai_api/                         # Основной пакет API приложения
│   │           ├─ __init__.py                 # Инициализация пакета ai_api
│   │           ├─ main.py                     # Главный файл приложения. Создание FastAPI экземпляра, подключение роутеров, middleware, обработчиков ошибок.
│   │           ├─ config.py                   # Конфигурация приложения. Загрузка настроек через libs.shared.config, настройка переменных окружения.
│   │           ├─ router.py                   # Главный роутер приложения. Объединяет все версионированные роуты (v1, v2 и т.д.).
│   │           ├─ deps.py                     # FastAPI зависимости (dependency injection). Фабрики для создания сервисов, подключение к БД, валидация.
│   │           │
│   │           ├─ api/                        # API endpoints организованные по версиям
│   │           │   └─ v1/                     # API версия 1
│   │           │       ├─ __init__.py         # Инициализация пакета v1 API
│   │           │       ├─ generate.py         # POST /v1/generate — endpoint для старта pipeline генерации тестов. Принимает спецификацию, возвращает ID запуска.
│   │           │       ├─ runs.py             # GET /v1/runs/{id} — endpoint для получения статуса выполнения pipeline. Возвращает прогресс, ошибки, метрики.
│   │           │       └─ artifacts.py        # GET /v1/runs/{id}/artifact — endpoint для получения сгенерированных артефактов (архивы, файлы тестов).
│   │           │
│   │           ├─ services/                   # Сервисный слой — адаптеры между HTTP и бизнес-логикой
│   │           │   ├─ __init__.py             # Инициализация пакета services
│   │           │   ├─ orchestrator_adapter.py # Тонкий адаптер: преобразует HTTP DTO в вызовы libs.agents.orchestrator. Валидация входных данных.
│   │           │   ├─ packager_adapter.py     # Адаптер для упаковки результатов. Вызывает libs.agents.packager и libs.systems.gitlab для создания MR.
│   │           │   └─ runner_adapter.py       # Адаптер для запуска тестов. Вызывает runner protocol (libs.agents.executor.runner_protocol) для выполнения тестов.
│   │           │
│   │           └─ schemas/                    # Pydantic схемы для валидации и сериализации HTTP запросов/ответов
│   │               ├─ __init__.py             # Инициализация пакета schemas
│   │               ├─ request.py              # Pydantic модели для HTTP request DTOs. Валидация входных данных, документирование API через схемы.
│   │               └─ response.py             # Pydantic модели для HTTP response DTOs. Стандартизация формата ответов, статусы, метаданные.
│   │
│   └─ worker/                                 # Опциональный фоновый worker для асинхронной обработки задач
│       │                                      # Используется для тяжелых операций (генерация тестов, выполнение pipeline) в фоне
│       ├─ pyproject.toml                      # Конфигурация сборки для worker приложения. Зависимости для Celery или asyncio worker.
│       ├─ requirements.txt                    # Python зависимости для worker. Celery, Redis, RabbitMQ клиенты, асинхронные библиотеки.
│       └─ src/                                # Исходный код worker приложения
│           └─ ai_worker/                      # Основной пакет worker приложения
│               ├─ __init__.py                 # Инициализация пакета ai_worker
│               ├─ worker_main.py              # Главный файл worker. Обработка очереди задач, запуск orchestrator tasks в фоне, управление воркерами.
│               └─ queue_client.py             # Абстракция для работы с очередями сообщений (RabbitMQ/Kafka). Использует libs.integrations для унификации интерфейса.
│
├─ libs/                                       # Переиспользуемые библиотеки — нижние слои архитектуры
│   │                                          # Важно: библиотеки не должны импортировать код из apps/ (обратная зависимость запрещена)
│   │
│   ├─ shared/                                 # Общая библиотека — базовые модели, утилиты, конфигурация используемые повсюду
│   │   ├─ pyproject.toml                      # Конфигурация сборки для shared библиотеки. Минимальные зависимости, используется другими библиотеками.
│   │   ├─ __init__.py                         # Инициализация пакета shared. Экспортирует основные классы и функции.
│   │   ├─ config.py                           # Централизованная конфигурация через Pydantic Settings. Парсинг переменных окружения, валидация настроек.
│   │   ├─ models.py                           # Базовые доменные модели (Pydantic): TestSpec, EndpointModel, TestPlan, Run, Artifact. Общие для всего проекта.
│   │   ├─ exceptions.py                       # Общие исключения домена. Базовые классы ошибок, специфичные исключения для обработки в разных слоях.
│   │   ├─ constants.py                        # Константы проекта. Магические числа, строки, флаги используемые в разных частях системы.
│   │   ├─ types.py                            # Type aliases и TypeVar для типизации. Упрощение сложных типов, переиспользование типов.
│   │   └─ utils/                              # Утилиты общего назначения
│   │       ├─ __init__.py                     # Инициализация пакета utils
│   │       ├─ hashing.py                      # Утилиты для хеширования. MD5, SHA для файлов, контента. Проверка целостности данных.
│   │       ├─ time_utils.py                   # Утилиты для работы со временем. Форматирование, парсинг, timezone операции, относительное время.
│   │       └─ io_helpers.py                   # Вспомогательные функции для ввода/вывода. Чтение/запись файлов, работа с путями, временными файлами.
│   │
│   ├─ agents/                                 # Библиотека агентов — ядро бизнес-логики для генерации тестов
│   │   │                                      # Содержит все компоненты pipeline: от парсинга спецификаций до упаковки результатов
│   │   ├─ pyproject.toml                      # Конфигурация сборки для agents библиотеки. Зависимости для LLM, AST парсинга, валидации кода.
│   │   ├─ __init__.py                         # Инициализация пакета agents. Экспортирует основные интерфейсы агентов.
│   │   │
│   │   ├─ orchestrator/                       # Оркестратор — координирует весь pipeline генерации тестов
│   │   │   ├─ __init__.py                     # Инициализация пакета orchestrator
│   │   │   ├─ orchestrator.py                 # Ядро оркестратора. Координация шагов pipeline: Spec → Plan → Generate → Synthesize → Validate → Package.
│   │   │   ├─ workflow.py                     # Описание шагов pipeline и их последовательности. Управление состоянием, переходы между этапами.
│   │   │   └─ metrics.py                      # Метрики и трейсинг. Сбор статистики выполнения, интеграция с системами мониторинга (Prometheus, OpenTelemetry).
│   │   │
│   │   ├─ spec_loader/                        # Загрузчик спецификаций — парсит входные спецификации (OpenAPI, JSON)
│   │   │   ├─ __init__.py                     # Инициализация пакета spec_loader
│   │   │   ├─ parser.py                       # Парсер спецификаций. OpenAPI/JSON → внутренняя модель (TestSpec). Валидация формата, извлечение endpoints.
│   │   │   └─ normalizer.py                   # Нормализация спецификаций. Приведение к единому формату, обогащение метаданными, обработка нестандартных случаев.
│   │   │
│   │   ├─ ui_parser/                          # Парсер UI схем — преобразует UI описания в тестируемую модель
│   │   │   ├─ __init__.py                     # Инициализация пакета ui_parser
│   │   │   └─ parser.py                       # Парсер UI схем. UI schema → DOM-like внутренняя модель. Извлечение элементов, действий, состояний интерфейса.
│   │   │
│   │   ├─ planner/                            # Планировщик — генерирует план тестирования на основе спецификаций
│   │   │   ├─ __init__.py                     # Инициализация пакета planner
│   │   │   ├─ planner.py                      # Основной планировщик. Генерирует TestPlan с вариантами тестов, приоритетами, покрытием сценариев.
│   │   │   └─ heuristics.py                   # Эвристики для планирования. Правила определения важности тестов, оптимизация покрытия, приоритизация.
│   │   │
│   │   ├─ generator/                          # Генератор — создает код тестов через LLM
│   │   │   ├─ __init__.py                     # Инициализация пакета generator
│   │   │   ├─ prompt_builder.py               # Построитель промптов. Собирает промпты из шаблонов (packages/prompt_templates), подставляет контекст.
│   │   │   ├─ generator.py                    # Высокоуровневый генератор. Вызывает LLM через интерфейс (libs.integrations.interfaces.llm), управляет сессиями.
│   │   │   └─ formatter.py                    # Постобработка результата LLM. LLM ответ → валидные code snippets. Очистка, форматирование, извлечение кода.
│   │   │
│   │   ├─ synthesizer/                        # Синтезатор — собирает отдельные фрагменты кода в готовые файлы проекта
│   │   │   ├─ __init__.py                     # Инициализация пакета synthesizer
│   │   │   ├─ ast_utils.py                    # Утилиты для работы с AST. Использует libcst/tree-sitter для анализа и модификации кода на уровне AST.
│   │   │   └─ file_builder.py                 # Построитель файлов. Собирает финальные файлы проекта из сгенерированных фрагментов, создает структуру директорий.
│   │   │
│   │   ├─ validator/                          # Валидатор — проверяет качество сгенерированного кода
│   │   │   ├─ __init__.py                     # Инициализация пакета validator
│   │   │   ├─ lint.py                         # Линтер. Запускает black/ruff/mypy проверку на сгенерированных файлах. Форматирование, статический анализ.
│   │   │   └─ semantic_checks.py              # Семантические проверки. Правила AAA (Arrange-Act-Assert), корректность структуры тестов, best practices.
│   │   │
│   │   ├─ executor/                           # Исполнитель — интерфейс для запуска тестов
│   │   │   ├─ __init__.py                     # Инициализация пакета executor
│   │   │   ├─ executor.py                     # Высокоуровневый интерфейс запуска тестов. Координация выполнения, сбор результатов, обработка ошибок.
│   │   │   └─ runner_protocol.py              # Протокол (Protocol/abstract class) для runner. Определяет интерфейс, который реализует apps/runner для конкретного фреймворка.
│   │   │
│   │   └─ packager/                           # Упаковщик — готовит артефакты для доставки (архивы, MR)
│   │       ├─ __init__.py                     # Инициализация пакета packager
│   │       ├─ packager.py                     # Основной упаковщик. Собирает архив с тестами, формирует MR payload для GitLab, управляет версионированием.
│   │       └─ structure.py                    # Структура пакета. Определяет layout архива, организацию файлов, метаданные пакета.
│   │
│   ├─ integrations/                           # Библиотека интеграций — определения интерфейсов и протоколов для внешних систем
│   │   │                                      # Содержит абстракции (Protocol), конкретные реализации находятся в libs.systems
│   │   ├─ pyproject.toml                      # Конфигурация сборки для integrations библиотеки. Минимальные зависимости, только для определения интерфейсов.
│   │   ├─ __init__.py                         # Инициализация пакета integrations. Экспортирует основные протоколы.
│   │   │
│   │   ├─ interfaces/                         # Интерфейсы (Protocol) для внешних сервисов
│   │   │   ├─ __init__.py                     # Инициализация пакета interfaces
│   │   │   ├─ git.py                          # Протокол GitService. Определяет интерфейс: create_mr, commit, branch. Используется для абстракции Git операций.
│   │   │   ├─ llm.py                          # Протокол LLMService. Определяет интерфейс: generate, stream. Абстракция для работы с различными LLM провайдерами.
│   │   │   └─ vectorstore.py                  # Протокол VectorStore. Определяет интерфейс: upsert, search. Абстракция для векторных баз данных (RAG).
│   │   │
│   │   └─ mocks/                              # Моки для интерфейсов — используются в юнит-тестах
│   │       ├─ __init__.py                     # Инициализация пакета mocks
│   │       └─ local_git_stub.py               # Заглушка для локального Git сервиса. Используется в тестах вместо реального GitLab API.
│   │
│   ├─ systems/                                # Библиотека систем — конкретные реализации интерфейсов из libs.integrations
│   │   │                                      # Содержит реальные клиенты для GitLab, LLM провайдеров, векторных БД, хранилищ
│   │   ├─ pyproject.toml                      # Конфигурация сборки для systems библиотеки. Зависимости для HTTP клиентов, SDK внешних сервисов.
│   │   ├─ __init__.py                         # Инициализация пакета systems. Экспортирует основные клиенты.
│   │   │
│   │   ├─ gitlab/                             # GitLab интеграция
│   │   │   ├─ __init__.py                     # Инициализация пакета gitlab
│   │   │   ├─ client.py                       # Конкретный GitLab клиент. Реализует interfaces.git.GitService через GitLab API. Создание MR, коммиты, ветки.
│   │   │   └─ uploader.py                     # Загрузчик в GitLab. Управление загрузкой файлов, обработка больших архивов, ретраи при ошибках.
│   │   │
│   │   ├─ llm/                                # LLM провайдеры
│   │   │   ├─ __init__.py                     # Инициализация пакета llm
│   │   │   ├─ cloud_llm_client.py             # Реализация LLMService для облачных провайдеров (OpenAI, Anthropic). Retries, backoff, обработка rate limits.
│   │   │   └─ local_llm_stub.py               # Заглушка для локального LLM (dev/stub). Используется для разработки без реальных API вызовов.
│   │   │
│   │   ├─ qdrant/                             # Qdrant векторная БД
│   │   │   ├─ __init__.py                     # Инициализация пакета qdrant
│   │   │   ├─ qdrant_client.py                # Конкретная реализация VectorStore через Qdrant. Подключение, создание коллекций, поиск похожих тестов.
│   │   │   └─ indexer_impl.py                 # Реализация индексатора. Индексация сгенерированных тестов для RAG, поиск по семантике.
│   │   │
│   │   └─ storage/                            # Хранилища для артефактов
│   │       ├─ __init__.py                     # Инициализация пакета storage
│   │       ├─ s3_client.py                    # S3 клиент для хранения артефактов. Загрузка/скачивание архивов, управление жизненным циклом файлов.
│   │       └─ local_fs_store.py               # Локальное файловое хранилище. Используется для dev окружения, тестирования без S3.
│   │
│   └─ infrastructure/                         # Инфраструктурная библиотека — работа с БД, файловой системой, миграциями
│       │                                      # Низкоуровневые операции хранения и персистентности данных
│       ├─ pyproject.toml                      # Конфигурация сборки для infrastructure библиотеки. SQLAlchemy, Alembic, драйверы БД.
│       ├─ __init__.py                         # Инициализация пакета infrastructure
│       │
│       ├─ db/                                 # Работа с базой данных
│       │   ├─ __init__.py                     # Инициализация пакета db
│       │   ├─ models.py                       # SQLAlchemy модели. Run (запуск pipeline), Artifact (результаты), Override (переопределения настроек).
│       │   ├─ repo.py                         # Репозитории для работы с сущностями. CRUD операции для Run/Artifact, паттерн Repository.
│       │   └─ session.py                      # Фабрика сессий БД. Создание engine, session factory, управление транзакциями, connection pooling.
│       │
│       ├─ migrations/                         # Миграции базы данных (Alembic)
│       │   └─ versions/                       # Версии миграций. Хранит SQL скрипты для изменения схемы БД, управление версионированием схемы.
│       │       └─ .gitkeep                    # Заглушка для сохранения пустой директории в git
│       │
│       └─ fs/                                 # Работа с файловой системой
│           ├─ __init__.py                     # Инициализация пакета fs
│           └─ artifacts_fs.py                 # Низкоуровневые операции чтения/записи артефактов. Работа с файлами тестов, архивами, временными директориями.
│
├─ packages/                                   # Шаблоны и статические ресурсы — локально для AI подпроекта
│   │                                          # Содержит Jinja2 шаблоны промптов и шаблоны структуры тестов
│   │
│   ├─ prompt_templates/                       # Jinja2 шаблоны для генерации промптов LLM
│   │   ├─ generate_test_prompt.j2             # Шаблон промпта для генерации тестов. Подстановка контекста спецификации, требований, примеров.
│   │   └─ debug_prompt.j2                    # Шаблон промпта для отладки. Диагностика проблем генерации, анализ ошибок.
│   │
│   └─ test_templates/                         # Шаблоны структуры тестов для разных фреймворков
│       ├─ pytest/                             # Шаблоны для pytest
│       │   ├─ conftest.py                     # Шаблон conftest.py. Общие фикстуры, настройки pytest, переиспользуемые хелперы.
│       │   └─ template_test_sample.py         # Шаблон примера теста. Базовая структура теста, примеры использования фикстур.
│       └─ playwright/                         # Шаблоны для Playwright
│           └─ template_playwright.yml         # Шаблон конфигурации Playwright. Настройки браузеров, проекты, параметры запуска.
│
├─ examples/                                   # Примеры использования — демонстрационные файлы для разработчиков
│   ├─ openapi_example.yaml                    # Пример OpenAPI спецификации. Демонстрирует формат входных данных для генерации API тестов.
│   ├─ ui_schema.json                          # Пример UI схемы. Демонстрирует формат описания интерфейса для генерации UI тестов.
│   └─ overrides.json                          # Пример файла переопределений. Демонстрирует как кастомизировать настройки генерации тестов.
│
├─ tests/                                      # Тесты проекта — покрытие функциональности
│   │                                          # Организованы по типам (unit/integration) и по модулям (libs/apps)
│   │
│   ├─ __init__.py                             # Инициализация пакета tests
│   │
│   ├─ unit/                                   # Юнит-тесты — тестирование отдельных модулей в изоляции
│   │   ├─ __init__.py                         # Инициализация пакета unit tests
│   │   │
│   │   ├─ libs/                               # Юнит-тесты для библиотек
│   │   │   ├─ __init__.py                     # Инициализация пакета unit tests для libs
│   │   │   │
│   │   │   ├─ agents/                         # Тесты агентов
│   │   │   │   ├─ __init__.py                 # Инициализация пакета unit tests для agents
│   │   │   │   └─ test_planner.py             # Тесты для планировщика. Проверка генерации планов, приоритизации, покрытия сценариев.
│   │   │   │
│   │   │   └─ systems/                        # Тесты систем
│   │   │       ├─ __init__.py                 # Инициализация пакета unit tests для systems
│   │   │       └─ test_qdrant_client.py       # Тесты для Qdrant клиента. Проверка подключения, индексации, поиска, обработки ошибок.
│   │   │
│   │   └─ apps/                               # Юнит-тесты для приложений
│   │       ├─ __init__.py                     # Инициализация пакета unit tests для apps
│   │       │
│   │       └─ api/                            # Тесты API
│   │           ├─ __init__.py                 # Инициализация пакета unit tests для api
│   │           └─ test_generate_endpoint.py   # Тесты для generate endpoint. Проверка валидации входных данных, обработки ошибок, формата ответов.
│   │
│   └─ integration/                            # Интеграционные тесты — тестирование взаимодействия компонентов
│       ├─ __init__.py                         # Инициализация пакета integration tests
│       ├─ test_end_to_end_pipeline.py         # End-to-end тест всего pipeline. От спецификации до готового MR, проверка всей цепочки.
│       └─ test_runner_integration.py          # Интеграционный тест runner. Проверка запуска реальных тестов, сбор результатов, обработка ошибок.
│
└─ docs/                                       # Документация проекта
    ├─ architecture.md                         # Архитектурная документация. Описание слоев, взаимодействие компонентов, принципы проектирования.
    ├─ runbook.md                              # Операционное руководство. Инструкции по развертыванию, мониторингу, troubleshooting, инцидентам.
    ├─ prompts.md                              # Документация по промптам. Описание шаблонов, примеры использования, настройка параметров генерации.
    └─ contribution.md                         # Руководство по внесению вклада. Процесс разработки, code style, процесс ревью, стандарты кода.

---

## Принципы архитектуры

### Слоистость
- **apps/** — верхний слой, точки входа
- **libs/** — переиспользуемые библиотеки, не зависят от apps/
- **libs/infrastructure** — самый нижний слой, базовые операции

### Правило импортов
- `libs/*` НЕ могут импортировать из `apps/*`
- `apps/*` могут импортировать из `libs/*`
- Внутри `libs/` есть зависимость: infrastructure → systems → integrations → agents → shared

### Модульность
- Каждая библиотека в `libs/` имеет свой `pyproject.toml`
- Каждое приложение в `apps/` имеет свой `pyproject.toml` и `requirements.txt`
- Независимая установка и тестирование модулей

---

## Заметки

- Все `__init__.py` файлы созданы для корректной работы Python пакетов
- Файлы с расширениями `.j2` — Jinja2 шаблоны для генерации промптов
- Скрипты в `scripts/` должны быть исполняемыми (chmod +x)
- Миграции БД хранятся в `libs/infrastructure/migrations/versions/`
- Примеры в `examples/` служат документацией форматов входных данных
